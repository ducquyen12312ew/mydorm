<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H√†ng ƒë·ª£i ∆∞u ti√™n - DomiSys Admin</title>
    <link rel="stylesheet" href="/css/admin-priority-queue.css">
</head>
<body>
    <div class="admin-container">
        <header class="admin-header">
            <div class="header-content">
                <h1>H√†ng ƒë·ª£i ∆∞u ti√™n ƒëƒÉng k√Ω ph√≤ng</h1>
                <div class="header-actions">
                    <button class="btn-refresh" onclick="loadQueue()">L√†m m·ªõi</button>
                    <button class="btn-auto-assign" onclick="showAutoAssignModal()">Ph√¢n ph√≤ng t·ª± ƒë·ªông</button>
                </div>
            </div>
        </header>

        <div class="stats-section">
            <div class="stat-card">
                <div class="stat-icon">üë•</div>
                <div class="stat-content">
                    <div class="stat-value" id="totalStudents">0</div>
                    <div class="stat-label">T·ªïng sinh vi√™n</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚è≥</div>
                <div class="stat-content">
                    <div class="stat-value" id="pendingStudents">0</div>
                    <div class="stat-label">ƒêang ch·ªù</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">‚úÖ</div>
                <div class="stat-content">
                    <div class="stat-value" id="assignedStudents">0</div>
                    <div class="stat-label">ƒê√£ ph√¢n ph√≤ng</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üèÜ</div>
                <div class="stat-content">
                    <div class="stat-value" id="avgPriority">0</div>
                    <div class="stat-label">ƒêi·ªÉm TB</div>
                </div>
            </div>
        </div>

        <div class="content-wrapper">
            <div class="filter-section">
                <select id="yearGroupFilter" onchange="filterQueue()">
                    <option value="">T·∫•t c·∫£ nh√≥m nƒÉm</option>
                    <option value="1">NƒÉm 1</option>
                    <option value="2">NƒÉm 2-3</option>
                    <option value="3">NƒÉm 4+</option>
                </select>
                <select id="statusFilter" onchange="filterQueue()">
                    <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                    <option value="pending">ƒêang ch·ªù</option>
                    <option value="assigned">ƒê√£ ph√¢n</option>
                    <option value="rejected">B·ªã t·ª´ ch·ªëi</option>
                </select>
                <input type="text" id="searchInput" placeholder="T√¨m theo MSSV ho·∫∑c t√™n..." onkeyup="filterQueue()">
            </div>

            <div class="queue-table-container">
                <table class="queue-table">
                    <thead>
                        <tr>
                            <th>H·∫°ng</th>
                            <th>MSSV</th>
                            <th>H·ªç v√† t√™n</th>
                            <th>NƒÉm h·ªçc</th>
                            <th>Nh√≥m</th>
                            <th>ƒêi·ªÉm ∆∞u ti√™n</th>
                            <th>Ph√≤ng hi·ªán t·∫°i</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="queueTableBody">
                        <tr>
                            <td colspan="9" class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="autoAssignModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ph√¢n ph√≤ng t·ª± ƒë·ªông</h2>
                <button class="close-btn" onclick="closeAutoAssignModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông ph√¢n ph√≤ng cho sinh vi√™n d·ª±a tr√™n:</p>
                <ul>
                    <li>ƒêi·ªÉm ∆∞u ti√™n</li>
                    <li>Ch√≠nh s√°ch nƒÉm h·ªçc</li>
                    <li>Ph√≤ng tr·ªëng ph√π h·ª£p v·ªõi gi·ªõi t√≠nh</li>
                    <li>S·ªü th√≠ch ph√≤ng (n·∫øu c√≥)</li>
                </ul>
                <div class="form-group">
                    <label>Ch·ªçn nƒÉm h·ªçc:</label>
                    <select id="autoAssignYear">
                        <option value="">Ch·ªçn nƒÉm h·ªçc</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ch·ªçn nh√≥m nƒÉm:</label>
                    <select id="autoAssignYearGroup">
                        <option value="">T·∫•t c·∫£ nh√≥m</option>
                        <option value="1">NƒÉm 1</option>
                        <option value="2">NƒÉm 2-3</option>
                        <option value="3">NƒÉm 4+</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>S·ªë l∆∞·ª£ng sinh vi√™n t·ªëi ƒëa:</label>
                    <input type="number" id="autoAssignLimit" placeholder="ƒê·ªÉ tr·ªëng = t·∫•t c·∫£" min="1">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeAutoAssignModal()">H·ªßy</button>
                <button class="btn-confirm" onclick="executeAutoAssign()">B·∫Øt ƒë·∫ßu ph√¢n ph√≤ng</button>
            </div>
        </div>
    </div>

    <div id="studentDetailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Chi ti·∫øt sinh vi√™n</h2>
                <button class="close-btn" onclick="closeStudentDetailModal()">&times;</button>
            </div>
            <div class="modal-body" id="studentDetailContent">
            </div>
        </div>
    </div>

    <script>
        let allStudents = [];
        let filteredStudents = [];

        async function loadQueue() {
            try {
                const response = await fetch('/api/admin/priority-queue');
                const data = await response.json();
                
                if (data.success) {
                    allStudents = data.queue;
                    filteredStudents = allStudents;
                    renderQueue(filteredStudents);
                    updateStats(allStudents);
                }
            } catch (error) {
                console.error('Error loading queue:', error);
                document.getElementById('queueTableBody').innerHTML = 
                    '<tr><td colspan="9" class="error">Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu</td></tr>';
            }
        }

        function updateStats(students) {
            document.getElementById('totalStudents').textContent = students.length;
            
            const pending = students.filter(s => s.registrationStatus === 'pending').length;
            document.getElementById('pendingStudents').textContent = pending;
            
            const assigned = students.filter(s => 
                s.registrationStatus === 'assigned_room' || s.registrationStatus === 'checked_in'
            ).length;
            document.getElementById('assignedStudents').textContent = assigned;
            
            const avgPriority = students.length > 0 
                ? (students.reduce((sum, s) => sum + (s.priorityScore || 0), 0) / students.length).toFixed(1)
                : 0;
            document.getElementById('avgPriority').textContent = avgPriority;
        }

        function filterQueue() {
            const yearGroup = document.getElementById('yearGroupFilter').value;
            const status = document.getElementById('statusFilter').value;
            const search = document.getElementById('searchInput').value.toLowerCase();
            
            filteredStudents = allStudents.filter(student => {
                const matchYearGroup = !yearGroup || student.yearGroup == yearGroup;
                const matchStatus = !status || student.registrationStatus === status;
                const matchSearch = !search || 
                    student.studentId.toLowerCase().includes(search) || 
                    student.name.toLowerCase().includes(search);
                
                return matchYearGroup && matchStatus && matchSearch;
            });
            
            renderQueue(filteredStudents);
        }

        function renderQueue(students) {
            const tbody = document.getElementById('queueTableBody');
            
            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="empty">Kh√¥ng c√≥ sinh vi√™n n√†o</td></tr>';
                return;
            }
            
            tbody.innerHTML = students.map((student, index) => `
                <tr class="student-row ${getStatusClass(student.registrationStatus)}">
                    <td class="rank-cell">${index + 1}</td>
                    <td>${student.studentId}</td>
                    <td>${student.name}</td>
                    <td>NƒÉm ${student.academicYear}</td>
                    <td>
                        <span class="year-group-badge group-${student.yearGroup}">
                            ${getYearGroupLabel(student.yearGroup)}
                        </span>
                    </td>
                    <td>
                        <span class="priority-score">${student.priorityScore || 0}</span>
                    </td>
                    <td>${student.dormitoryId && student.roomNumber ? 
                        `${student.dormitoryName || 'N/A'} - ${student.roomNumber}` : 
                        '<span class="no-room">Ch∆∞a c√≥</span>'}</td>
                    <td>
                        <span class="status-badge status-${student.registrationStatus}">
                            ${getStatusLabel(student.registrationStatus)}
                        </span>
                    </td>
                    <td>
                        <button class="btn-detail" onclick="viewStudentDetail('${student._id}')">Chi ti·∫øt</button>
                        ${student.registrationStatus === 'pending' ? 
                            `<button class="btn-assign" onclick="manualAssign('${student._id}')">Ph√¢n ph√≤ng</button>` : 
                            ''}
                    </td>
                </tr>
            `).join('');
        }

        function getYearGroupLabel(group) {
            const labels = {
                1: 'NƒÉm 1',
                2: 'NƒÉm 2-3',
                3: 'NƒÉm 4+'
            };
            return labels[group] || 'N/A';
        }

        function getStatusLabel(status) {
            const labels = {
                'pending': 'ƒêang ch·ªù',
                'assigned_room': 'ƒê√£ ph√¢n',
                'checked_in': 'ƒê√£ nh·∫≠n',
                'rejected': 'T·ª´ ch·ªëi',
                'cancelled': 'H·ªßy'
            };
            return labels[status] || status;
        }

        function getStatusClass(status) {
            const classes = {
                'pending': 'pending',
                'assigned_room': 'assigned',
                'checked_in': 'checked-in',
                'rejected': 'rejected'
            };
            return classes[status] || '';
        }

        async function viewStudentDetail(studentId) {
            const student = allStudents.find(s => s._id === studentId);
            if (!student) return;
            
            const detailContent = `
                <div class="student-detail">
                    <div class="detail-section">
                        <h3>Th√¥ng tin c∆° b·∫£n</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <span class="detail-label">MSSV:</span>
                                <span class="detail-value">${student.studentId}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">H·ªç v√† t√™n:</span>
                                <span class="detail-value">${student.name}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">NƒÉm h·ªçc:</span>
                                <span class="detail-value">NƒÉm ${student.academicYear}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Khoa:</span>
                                <span class="detail-value">${student.faculty || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Gi·ªõi t√≠nh:</span>
                                <span class="detail-value">${student.gender === 'male' ? 'Nam' : 'N·ªØ'}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Email:</span>
                                <span class="detail-value">${student.email}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="detail-section">
                        <h3>Th√¥ng tin ƒëƒÉng k√Ω</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <span class="detail-label">Nh√≥m nƒÉm:</span>
                                <span class="detail-value">${getYearGroupLabel(student.yearGroup)}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">ƒêi·ªÉm ∆∞u ti√™n:</span>
                                <span class="detail-value priority-highlight">${student.priorityScore || 0}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Tr·∫°ng th√°i:</span>
                                <span class="detail-value">
                                    <span class="status-badge status-${student.registrationStatus}">
                                        ${getStatusLabel(student.registrationStatus)}
                                    </span>
                                </span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Ph√≤ng hi·ªán t·∫°i:</span>
                                <span class="detail-value">${student.dormitoryId && student.roomNumber ? 
                                    `${student.dormitoryName || 'N/A'} - ${student.roomNumber}` : 
                                    'Ch∆∞a c√≥'}</span>
                            </div>
                        </div>
                    </div>
                    
                    ${student.registrationHistory && student.registrationHistory.length > 0 ? `
                        <div class="detail-section">
                            <h3>L·ªãch s·ª≠ ƒëƒÉng k√Ω</h3>
                            <div class="history-list">
                                ${student.registrationHistory.map(h => `
                                    <div class="history-item">
                                        <div>${h.academicYear}</div>
                                        <div class="status-badge status-${h.status}">${getStatusLabel(h.status)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('studentDetailContent').innerHTML = detailContent;
            document.getElementById('studentDetailModal').style.display = 'flex';
        }

        function closeStudentDetailModal() {
            document.getElementById('studentDetailModal').style.display = 'none';
        }

        function showAutoAssignModal() {
            const select = document.getElementById('autoAssignYear');
            const currentYear = new Date().getFullYear();
            const nextYear = currentYear + 1;
            
            select.innerHTML = `
                <option value="${currentYear}-${nextYear}">${currentYear}-${nextYear}</option>
                <option value="${currentYear-1}-${currentYear}">${currentYear-1}-${currentYear}</option>
            `;
            
            document.getElementById('autoAssignModal').style.display = 'flex';
        }

        function closeAutoAssignModal() {
            document.getElementById('autoAssignModal').style.display = 'none';
        }

        async function executeAutoAssign() {
            const academicYear = document.getElementById('autoAssignYear').value;
            const yearGroup = document.getElementById('autoAssignYearGroup').value;
            const limit = document.getElementById('autoAssignLimit').value;
            
            if (!academicYear) {
                alert('Vui l√≤ng ch·ªçn nƒÉm h·ªçc');
                return;
            }
            
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën b·∫Øt ƒë·∫ßu ph√¢n ph√≤ng t·ª± ƒë·ªông?')) return;
            
            try {
                const response = await fetch('/api/admin/auto-assign-rooms', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        academicYear,
                        yearGroup: yearGroup || undefined,
                        limit: limit ? parseInt(limit) : undefined
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`Ph√¢n ph√≤ng th√†nh c√¥ng cho ${data.assignedCount} sinh vi√™n`);
                    closeAutoAssignModal();
                    loadQueue();
                } else {
                    alert('L·ªói: ' + data.error);
                }
            } catch (error) {
                console.error('Error in auto assign:', error);
                alert('Kh√¥ng th·ªÉ th·ª±c hi·ªán ph√¢n ph√≤ng t·ª± ƒë·ªông');
            }
        }

        async function manualAssign(studentId) {
            alert('T√≠nh nƒÉng ph√¢n ph√≤ng th·ªß c√¥ng ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn');
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };

        loadQueue();
    </script>
</body>
</html>
